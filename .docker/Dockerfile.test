ARG CLI_IMAGE
FROM ${CLI_IMAGE} as cli

FROM govcms8dev/test

COPY --from=cli /app /app
COPY .docker/sanitize.sh /app/sanitize.sh

RUN /app/sanitize.sh \
  && rm -rf /app/sanitize.sh

COPY .docker/images/test/* /app/web/sites/all/drutiny/profiles/

ENV SITE_AUDIT_VERSION more_profiles
ENV PATH="/app/vendor/bin:${PATH}"
RUN wget https://github.com/tobybellwood/audit-site/archive/$SITE_AUDIT_VERSION.tar.gz \
    && tar -C /tmp -xzvf $SITE_AUDIT_VERSION.tar.gz \
    && rm $SITE_AUDIT_VERSION.tar.gz \
    && mkdir -p /app/web/sites/all/drutiny \
    && mv /tmp/audit-site-$SITE_AUDIT_VERSION/* /app/web/sites/all/drutiny \
    && rm -Rf /tmp/audit-site-$SITE_AUDIT_VERSION \
    && php -d memory_limit=-1 /usr/local/bin/composer --working-dir=/app/web/sites/all/drutiny/ install --ignore-platform-reqs \
    && mv /app/web/sites/all/drutiny/profiles/drutiny /usr/bin/drutiny \
    && chmod +x /usr/bin/drutiny \
    && rm -rf /home/.composer/vendor/bin/drush.launcher
